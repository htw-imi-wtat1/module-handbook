# Sprint 05 - CRUD, Validation and Model Associations

## User CRUD

- Copied the relevant files from the book source code examples. 
  You can just use the files
  in `doc/user_crud` and copy them into your application. 
  The file `add_to_main.md` lists the changes 
  that needed to be done in other places.
- created tests(see below) and seeds for user. The seeds were done 
  with faker, see the files in `mongo/seed`


    npm install faker --save-dev
    
 
## Changes in userController

For the update action, replaced `findByIdAndUpdate` with `updateOne` (didn't work otherwise)

    <     User.findByIdAndUpdate(userId, {
    >     User.updateOne({ _id: userId }, userParams)

- Changed the getUserParams method to also accept nested parameters for the name. 
This makes it possible to send nested data objects via supertest send.


    <       first: body.first,
    <       last: body.last
    
    >       first: body.first || (body.name && body.name.first),
    >       last: body.last || (body.name && body.name.last)
  
## Testing

- created snapshot test for user/show
- created controller tests for user/create, user/delete and user/update

### Testing with a database

There are various possibilities to test an application. I will talk about them 
in the lecture. The way I've implemented is to test against an in-memory database
which is created for a jest run, with an own connection to from each individual file (suite)
in the `beforeAll` action in `test/commonJest.js`.

The identifying attributes that need to be unique - email for user and code for 
course - are varied using a random number generated by id() in `test/commonJest.js`

If you want your tests to run against a real database, set the environment variable
`MONGO_URL_USE_TEST` like this (or with a fitting the db connection string):

    export MONGO_URL_USE_TEST='mongodb://localhost:27017/modulehandbook_test_db'

"@shelf/jest-mongodb" creates and disposes a new test database for each
jest run through global setup and teardown in jest.
THUS, THE DB IS NOT CLEANED! 

If you want to delete your db, you can use `cleanTestDB.js`

### Testing Express Requests

The requests are tested using the library Supertest, which wraps Superagent. 
See the documentation for creating new tests:

* https://github.com/visionmedia/supertest
* https://visionmedia.github.io/superagent/

